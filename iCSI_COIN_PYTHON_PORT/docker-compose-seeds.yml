version: '3.8'

services:
  seed-node-1:
    build:
      context: ./end_user_node
    network_mode: "host"
    volumes:
      - ./end_user_node:/app
    # Seed 1: P2P 9333, RPC 9337 (No Web UI)
    command: [ "--port", "9333", "--bind", "0.0.0.0", "--rpcport", "9337", "--debug" ]
    deploy:
      restart_policy:
        condition: on-failure

  seed-node-2:
    build:
      context: ./end_user_node
    network_mode: "host"
    volumes:
      - ./end_user_node:/app
    # Seed 2: P2P 9334, RPC 9338 (No Web UI)
    command: [ "--port", "9334", "--bind", "0.0.0.0", "--addnode", "127.0.0.1:9333", "--rpcport", "9338" ]
    depends_on:
      - seed-node-1
    deploy:
      restart_policy:
        condition: on-failure

  seed-node-3:
    build:
      context: ./end_user_node
    network_mode: "host"
    volumes:
      - ./end_user_node:/app
    # Seed 3: P2P 9335, RPC 9339 (No Web UI)
    command: [ "--port", "9335", "--bind", "0.0.0.0", "--addnode", "127.0.0.1:9333", "--rpcport", "9339" ]
    depends_on:
      - seed-node-1
    deploy:
      restart_policy:
        condition: on-failure

  admin-node:
    build:
      context: ./end_user_node
    network_mode: "host"
    volumes:
      - ./end_user_node:/app
    # Admin Node: P2P 9336, RPC 9340, Web 5000
    # Connects to Seed 1, 2, 3
    # Note: --web-port arg might need verification in server.py, usually env var or arg.
    # Checking icsi_coin_server.py: it has --web-port
    command: [ "--port", "9336", "--bind", "0.0.0.0", "--rpcport", "9340", "--web-port", "5000", "--addnode", "127.0.0.1:9333", "--addnode", "127.0.0.1:9334", "--addnode", "127.0.0.1:9335" ]
    depends_on:
      - seed-node-1
      - seed-node-2
      - seed-node-3
    deploy:
      restart_policy:
        condition: on-failure

  stun-turn-server:
    image: coturn/coturn
    network_mode: "host"
    volumes:
      - ./turnserver.conf:/etc/coturn/turnserver.conf
    deploy:
      restart_policy:
        condition: on-failure
